# MAVLink Proxy

This lightweight proxy forwards MAVLink packets between the onboard autopilot endpoint and a remote QGroundControl (QGC) instance on the same network.

## Network Assumptions
- Onboard host (this machine): `10.3.1.32`
- Operator platform (QGC): `10.3.1.96`
- MAVLink UDP port: `14550` (common default)

## Files
- `mavlink_proxy.py` – Core bidirectional forwarder using `pymavlink`.
- `run_mavlink_proxy.sh` – Convenience wrapper with sensible defaults and env overrides.

## Prerequisites
Install pymavlink if not already available in the environment:
```
pip install pymavlink
```
(If running inside an existing ROS / AirStack environment that already has it, you can skip.)

## Quick Start
From the `airstack` directory on the onboard machine (10.3.1.32):
```
./run_mavlink_proxy.sh
```
This is equivalent to:
```
python3 mavlink_proxy.py \
  --autopilot udp:0.0.0.0:14550 \
  --qgc 10.3.1.96 \
  --qgc-port 14550
```
Open QGroundControl on the operator platform (10.3.1.96). It should automatically detect the MAVLink stream (if using auto-connect). If not, add a manual UDP connection on port 14550.

## Environment Variable Overrides
You can override defaults without editing scripts:
```
AUTOPILOT_EP=udp:0.0.0.0:14600 QGC_HOST=10.3.1.50 QGC_PORT=14551 ./run_mavlink_proxy.sh
```
Optional fixed source port for outbound (helpful for firewall pinning):
```
BIND_QGC_PORT=14650 ./run_mavlink_proxy.sh
```

## Passing Additional Arguments
Anything after `--` is passed directly to `mavlink_proxy.py`:
```
./run_mavlink_proxy.sh -- --print-stats --stats-interval 5
```

## Direct Python Invocation
```
python3 mavlink_proxy.py -h
```

## How It Works
Two threads:
- Autopilot -> QGC: Reads parsed MAVLink messages from the autopilot endpoint and writes raw frames to the QGC link.
- QGC -> Autopilot: Forwards messages in the reverse direction (useful for parameter changes, mission upload, arm commands, etc.).

The script relies on `pymavlink.mavutil.mavlink_connection` with `autoreconnect` enabled.

## Limitations / Notes
- This does not multiplex multiple GCS clients; it simply bridges two endpoints.
- If another process already binds `udp:0.0.0.0:14550`, change `--autopilot` to a different port or stop the other process.
- If you already run `mavlink-router` or `mavproxy`, you may prefer those for advanced routing / logging.
- No persistent logging is enabled here; add one if needed.

## Troubleshooting
| Symptom | Possible Cause | Fix |
|---------|----------------|-----|
| No vehicle in QGC | Wrong IP / port | Verify `--qgc`, port, and network reachability (ping). |
| Port already in use | Another MAVLink service running | `lsof -iUDP:14550` (or change port). |
| One-way traffic only | Firewall blocking outbound/inbound UDP | Adjust firewall rules or use a different port. |
| QGC shows multiple duplicates | Multiple forwarders running simultaneously | Ensure only one instance of the proxy. |

## Stopping
Press `Ctrl+C` in the terminal that started the proxy.

## Future Enhancements (Ideas)
- Optional logging to MCAP or BIN.
- Multiple GCS clients (fan-out).
- Health/heartbeat metrics HTTP endpoint.

---
Generated by Copilot.
